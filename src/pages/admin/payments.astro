---
import AdminLayout from "../../layouts/AdminLayout.astro";
import PaymentsTable from "../../components/admin/PaymentsTable";
import PaymentStats from "../../components/admin/PaymentStats";
import { createSupabaseServiceRoleClient } from "../../lib/supabase";
import { SERVICES } from "../../components/booking/service-data";

export const prerender = false;

const supabase = createSupabaseServiceRoleClient();

const { data: payments, error } = await supabase
  .from("bookings")
  .select(`
    id,
    session_date,
    service_type,
    payment_status,
    stripe_payment_intent_id,
    created_at,
    users (
      name,
      email
    )
  `)
  .neq("payment_status", "pending")
  .order("created_at", { ascending: false });

if (error) {
  console.error("Error fetching payments:", error);
}

const totalRevenue = payments?.reduce((sum, p) =>
  p.payment_status === "paid" ? sum + (SERVICES[p.service_type]?.price || 0) : sum, 0) || 0;

const paidCount = payments?.filter(p => p.payment_status === "paid").length || 0;
const refundedCount = payments?.filter(p => p.payment_status === "refunded").length || 0;
const failedCount = payments?.filter(p => p.payment_status === "failed").length || 0;

const stats = { totalRevenue, paidCount, refundedCount, failedCount };
---

<AdminLayout title="Payments | Admin Panel" activePage="payments">
  <div class="space-y-6">
    <div>
      <h1 class="text-3xl font-bold text-black">Payments</h1>
      <p class="text-gray-600 mt-1">View payment history and transaction details</p>
    </div>

    <PaymentStats stats={stats} />

    <PaymentsTable client:load payments={payments || []} />
  </div>
</AdminLayout>
